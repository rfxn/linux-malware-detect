#!/usr/bin/env bash
#
##
# Linux Malware Detect v1.6.2
#             (C) 2002-2017, R-fx Networks <proj@r-fx.org>
#             (C) 2017, Ryan MacDonald <ryan@r-fx.org>
# This program may be freely redistributed under the terms of the GNU GPL v2
##
#
PATH=$PATH:/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin
ver=1.6
prefix=
inspath=/usr/local/maldetect
binpath=/usr/local
conftemp="$inspath/internals/importconf"
clamav=
clamav_paths="/usr/local/cpanel/3rdparty/share/clamav/ /var/lib/clamav/ /var/clamav/ /usr/share/clamav/ /usr/local/share/clamav"
autostart=1

T=$(getopt -o "" --long "prefix:,installdir:,binprefix:,with-clamav::,no-clamav,autostart,no-autostart,errexit" -n "$0" -- "$@")
eval set -- "${T}"

while [ $# -gt 0 ]; do
	case "$1" in
		--prefix)
			prefix="$2"
			shift 2
			;;
		--installdir)
			inspath="$2"
			shift 2
			;;
		--binprefix)
			binpath="$2"
			shift 2
			;;
		--no-clamav)
			clamav="-"
			shift
			;;
		--with-clamav)
			clamav="$2"
			shift 2
			;;
		--no-autostart)
			autostart=
			shift
			;;
		--autostart)
			autostart=1
			shift
			;;
		--errexit)
			set -o errexit
			shift
			;;
		--)
			shift $#
			;;
		*)
			echo "Invalid option ($1) supplied." >&2
			exit 1
		;;
	esac
done

logf="${inspath}/logs/event_log"

if [ -z "${clamav}" ]; then
	for lp in ${clamav_paths}; do
		[ -d "${lp}" ] && clamav="${lp}" && break
	done
fi

if [ -z "${prefix}" -a -d "$inspath" ]; then
	if [ "$(ps -A --user root -o "cmd" 2> /dev/null | grep maldetect | grep inotifywait)" ]; then
		$inspath/maldet -k >> /dev/null 2>&1
		monmode=1
	fi
	find "${inspath}".* -maxdepth 0 -type d -mtime +30 2> /dev/null | xargs rm -rf
	mv "${inspath}" "${inspath}.bk$$"
	ln -fs "$(basename "$inspath.bk$$")" "${inspath}.last"
	cp -f $inspath.bk$$/ignore_* $inspath/  >> /dev/null 2>&1
	if [ "$ver" == "1.5" ] || [ "$ver" == "1.6" ]; then
		cp -f $inspath.bk$$/sess/* $inspath/sess/ >> /dev/null 2>&1
		cp -f $inspath.bk$$/tmp/* $inspath/tmp/ >> /dev/null 2>&1
		cp -f $inspath.bk$$/quarantine/* $inspath/quarantine/ >> /dev/null 2>&1
                cp -f $inspath.bk$$/cron/* $inspath/cron/
	fi
	cp -f $inspath.bk$$/sigs/custom.* $inspath/sigs/ >> /dev/null 2>&1
	cp -f $inspath.bk$$/monitor_paths $inspath/ >> /dev/null 2>&1
	cp -pf $inspath.bk$$/clean/custom.* $inspath/clean/ >> /dev/null 2>&1
fi

mkdir -p "$prefix/$inspath"
chmod 755 "$prefix/$inspath"
cp -pR files/* "$prefix/$inspath"
chmod 755 "$prefix/$inspath/maldet"
mkdir -p "$prefix/$inspath/"{clean,pub,quarantine,sess,sigs,tmp}
chmod 750 "$prefix/$inspath/"{quarantine,sess,tmp,internals/tlog}
gzip -9 "${prefix}$inspath/maldet.1"
cp -f CHANGELOG COPYING.GPL README "${prefix}/$inspath/"

if [ -n "${binpath}" ]; then
	mkdir -p "${prefix}${binpath}/sbin"
	ln -fs ${inspath}/maldet "${prefix}/${binpath}/sbin/maldet"
	ln -fs ${inspath}/maldet "${prefix}/${binpath}/sbin/lmd"

	mkdir -p "${prefix}${binpath}/share/man/man1/"
	ln -fs "${inspath}/maldet.1.gz" "${prefix}${binpath}/share/man/man1/maldet.1.gz"
fi


if [ -z "${prefix}" -a -d "${inspath}.bk$$" ]; then
	cp -f "${inspath}.bk$$"/ignore_* "${inspath}/" &>/dev/null
	if [ "$ver" == "1.5" ] || [ "$ver" == "1.6" ]; then
		cp -f $inspath.bk$$/sess/* $inspath/sess/ >> /dev/null 2>&1
		cp -f $inspath.bk$$/tmp/* $inspath/tmp/ >> /dev/null 2>&1
		cp -f $inspath.bk$$/quarantine/* $inspath/quarantine/ >> /dev/null 2>&1
                cp -f $inspath.bk$$/cron/* $inspath/cron/
	fi
	cp -f $inspath.bk$$/sigs/custom.* $inspath/sigs/ >> /dev/null 2>&1
	cp -f $inspath.bk$$/monitor_paths $inspath/ >> /dev/null 2>&1
	cp -pf $inspath.bk$$/clean/custom.* $inspath/clean/ >> /dev/null 2>&1
fi

if [ "${clamav}" != "-" -a -d "${clamav}" ]; then
	mkdir -p "${prefix}${clamav}"
	[ -z "${prefix}" ] && rm -f "$clamav"/{lmd.user,rfxn}.*

	ln -sf $inspath/sigs/rfxn.ndb $inspath/sigs/rfxn.hdb "${prefix}${clamav}/"
	ln -sf $inspath/sigs/lmd.user.ndb $inspath/sigs/lmd.user.hdb "${prefix}${clamav}/"

	[ -z "${prefix}" ] && killall -SIGUSR2 clamd 2> /dev/null
fi

if [ -d "/etc/cron.daily" ]; then
	mkdir -p "${prefix}/etc/cron.daily"
	cp -f cron.daily "${prefix}/etc/cron.daily/maldet"
	chmod 755 "${prefix}/etc/cron.daily/maldet"
fi

if [ -d "/etc/cron.d" ]; then
	mkdir -p "${prefix}/etc/cron.d"
	cp -f cron.d.pub "${prefix}/etc/cron.d/maldet_pub"
	chmod 644 "${prefix}/etc/cron.d/maldet_pub"
fi

if [ "$(uname -s)" != "FreeBSD" -a -n "${autostart}" ]; then
        if test "$(cat /proc/1/comm 2> /dev/null)" == "systemd"
        then
                mkdir -p /etc/systemd/system/
                mkdir -p /usr/lib/systemd/system/
                cp -af ./files/service/maldet.service /usr/lib/systemd/system/
                systemctl daemon-reload
                systemctl enable maldet.service
	else
                cp -af ./files/service/maldet.sh /etc/init.d/maldet
                chmod 755 /etc/init.d/maldet
		chkconfig --level 2345 maldet on
	fi
	if [ -f /etc/redhat-release ]; then
		if [ ! -f "/etc/sysconfig/maldet" ]; then
			cp -f ./files/service/maldet.sysconfig /etc/sysconfig/maldet
		fi
	elif [ -f /etc/debian_version ] || [ -f /etc/lsb-release ]; then
		if [ ! -f "/etc/default/maldet" ]; then
			cp -f ./files/service/maldet.sysconfig /etc/default/maldet
		fi
		update-rc.d -f maldet remove
		update-rc.d maldet defaults 70 30
	elif [ -f /etc/gentoo-release ]; then
		rc-update add maldet default
	elif [ -f /etc/slackware-version ]; then
		ln -sf /etc/init.d/maldet /etc/rc.d/rc3.d/S70maldet
		ln -sf /etc/init.d/maldet /etc/rc.d/rc4.d/S70maldet
		ln -sf /etc/init.d/maldet /etc/rc.d/rc5.d/S70maldet
	else
		if [ ! -f "/etc/sysconfig/maldet" ]; then
			cp -f ./files/service/maldet.sysconfig /etc/sysconfig/maldet 2> /dev/null
		fi
		/sbin/chkconfig maldet on
	fi
fi

mkdir -p "${prefix}$inspath/logs" && touch "${prefix}${logf}"
ln -fs "${logf}" "${prefix}${inspath}/event_log"
[ -z "${prefix}" ] && $inspath/maldet --alert-daily 2> /dev/null

echo "Linux Malware Detect v$ver"
echo "            (C) 2002-2017, R-fx Networks <proj@r-fx.org>"
echo "            (C) 2017, Ryan MacDonald <ryan@r-fx.org>"
echo "This program may be freely redistributed under the terms of the GNU GPL"
echo ""
echo "installation completed to $inspath"
echo "config file: $inspath/conf.maldet"
echo "exec file: $inspath/maldet"
echo "exec link: /usr/local/sbin/maldet"
echo "exec link: /usr/local/sbin/lmd"
echo "cron.daily: /etc/cron.daily/maldet"
if [ -z "${prefix}" ]; then
	if [ -f "$conftemp" ] && [ -f "${inspath}.last/conf.maldet" ]; then
		. files/conf.maldet
		. ${inspath}.last/conf.maldet
		if [ "$quarantine_hits" == "0" ] && [ "$quar_hits" == "1" ]; then
			quarantine_hits=1
		fi
		if [ "$quarantine_clean" == "0" ] && [ "$quar_clean" == "1" ]; then
			quarantine_clean="1"
		fi
		if [ -f "files/internals/compat.conf" ]; then
			source files/internals/compat.conf
		fi
		source $conftemp
		echo "imported config options from $inspath.last/conf.maldet"
	fi
	$inspath/maldet --update 1
	if [ "$monmode" == "1" ]; then
		echo "detected active monitoring mode, restarted inotify watch with '-m users'"
		$inspath/maldet -m users >> /dev/null 2>&1 &
	fi
fi
echo ""
