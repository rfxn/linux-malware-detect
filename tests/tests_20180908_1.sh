#! /bin/bash

echo -e "\e[34mTesting scanning with clamscan\e[00m"

### Copy over files
cp -a "$d_MALDET"/maldet "$d_MALDET_TESTS_WORKING"/maldet
cp -a "$d_MALDET"/internals/functions "$d_MALDET_TESTS_WORKING"/functions

v_CONFIG=email_alert="0",scan_clamscan="1",quarantine_hits="0",quarantine_clean="0",quarantine_suspend_user="0",scan_tmpdir_paths="",ignore_paths="$d_MALDET_TESTS_WORKING/ignore_paths"

### Modify maldet executable to point to the modified functions file
sed -i '/source $intfunc/i intfunc="'"$d_MALDET_TESTS_WORKING/functions\"" "$d_MALDET_TESTS_WORKING"/maldet
### Find the correct line in "finctions" to insert
v_SELECTOR_LINE="$( grep -n "^clamselector[(][)]" "$d_MALDET_TESTS_WORKING"/functions | cut -d ":" -f1 )"
v_SELECTOR_END=
for i in $( grep -n "^[[:blank:]]*}" ../internals/functions | cut -d ":" -f1 ); do
	if [[ "$i" -gt "$v_SELECTOR_LINE" ]]; then
		v_SELECTOR_END="$i"
		break
	fi
done
### Test if we were able to find that line
if [[ -z "$v_SELECTOR_END" ]]; then
	echo "Cannot find the end of the 'clamselector' function. Moving forward with tests and crossing fingers"
else
	### Modify "functions" to exit out of clamselector with the current value of "$scan_clamscan"
	sed -i "$v_SELECTOR_END"'iecho "$scan_clamscan"; exit' "$d_MALDET_TESTS_WORKING"/functions
	### Checking if clamscan is present
	v_RESULTS="$( "$d_MALDET_TESTS_WORKING"/maldet --config-option "$v_CONFIG" -a "$d_MALDET_TESTS_WORKING" | tail -n1 )"
	if [[ "$v_RESULTS" == "0" ]]; then
		echo -e "\e[33mClamscan not present. Skipping tests.\e[00m"
		exit 0
	fi
fi

### Acquire malicious files
wget -qO "$d_MALDET_TESTS_WORKING"/de404053a7f33585cd1ff655f62dec85 'https://raw.githubusercontent.com/rfxn/magento-malware-collection/master/malware/backend/de404053a7f33585cd1ff655f62dec85'
wget -qO "$d_MALDET_TESTS_WORKING"/8a86a21550fb7583887d8cecd484b497 'https://raw.githubusercontent.com/rfxn/magento-malware-collection/master/malware/backend/8a86a21550fb7583887d8cecd484b497'

### Change the ownership on said files
chown 500:500 "$d_MALDET_TESTS_WORKING"/*
touch "$d_MALDET_TESTS_WORKING"/ignore_paths

### Scan those files with clamscan
v_RESULTS="$( "$d_MALDET"/maldet --config-option "$v_CONFIG" -a "$d_MALDET_TESTS_WORKING" | grep "scan report saved" | awk '{print $NF}' )"

### 
if [[ $( grep -c "de404053a7f33585cd1ff655f62dec85\|8a86a21550fb7583887d8cecd484b497" "$d_MALDET"/sess/session.hits."$v_RESULTS" ) -ne 2 ]]; then
	echo "Scanning with Clamscan has failed" 2> /dev/stderr
	exit 1
fi
