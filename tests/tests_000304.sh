#! /bin/bash

echo -e "\e[34mTesting parsing of '--config-option' argument\e[00m"

echo "Note: Instead of using the maldet executable, this test copies and modifies it. If this test fails, it might be a result of unexpected future changes to '$d_MALDET/maldet'"

### Make a copy of the maldet executable
cp -a "$d_MALDET"/maldet "$d_MALDET_TESTS_WORKING"/maldet

### Find the line number for the "-co" / "--config-option" argument
v_CO_LINE="$( grep -En "^[[:blank:]]*-co" "$d_MALDET_TESTS_WORKING"/maldet | cut -d ":" -f1 )"
### Find the line number for where the next argument begins
v_NEXT_ARG_LINE="$( grep -En "^[[:blank:]]*(-|esac)" "$d_MALDET_TESTS_WORKING"/maldet | cut -d ":" -f1 | grep -A1 "^$v_CO_LINE" | tail -n1 )"

### Find the line number for the last time that we write something to "$tmpco" while processing the "-co" / "--config-option" argument
v_TMPCO_LINE=
for i in $( grep -En '> ?"?\$tmpco' "$d_MALDET_TESTS_WORKING"/maldet | cut -d ":" -f1 ); do
	if [[ "$i" -gt "$v_CO_LINE" && "$i" -lt "$v_NEXT_ARG_LINE" ]]; then
		v_TMPCO_LINE="$i"
	elif [[ "$i" -ge "$v_NEXT_ARG_LINE" ]]; then
		break
	fi
done

if [[ -z "$v_TMPCO_LINE" ]]; then
	echo 'Was not able to find file "$tmpco" being written to while processing the argument "-co" / "--config-option"' > /dev/stderr
	exit 1
fi

### Modify maldet so that it will print the file and then exit rather than deleting the file and moving forward
sed -i "$(( $v_TMPCO_LINE + 1 ))i"'cat $tmpco; exit' "$d_MALDET_TESTS_WORKING"/maldet

### Create an import the temp conf file
v_CONF=scan_tmpdir_paths="/tmp /var/tmp /dev/shm",inotify_docroot="public_html,public_ftp",md5sum="/sbin/md5",MONITOR_MODE="users",compatcnf="/home/user/malicious_executable.sh"
"$d_MALDET_TESTS_WORKING"/maldet -co "$v_CONF" > "$d_MALDET_TESTS_WORKING"/source
. "$d_MALDET_TESTS_WORKING"/source

### Test the variables that were imported
if [[ "$scan_tmpdir_paths" != "/tmp /var/tmp /dev/shm" || "$inotify_docroot" != "public_html,public_ftp" || "$md5sum" != "/sbin/md5" || "$MONITOR_MODE" != "users" || -n "$compatcnf" ]]; then
	echo 'Failed to parse "-co" arguments correctly' > /dev/stderr
	exit 1
fi

exit 0

