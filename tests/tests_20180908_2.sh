#! /bin/bash

echo -e "\e[34mTesting scanning without clamscan\e[00m"

### Acquire malicious files
wget -qO "$d_MALDET_TESTS_WORKING"/de404053a7f33585cd1ff655f62dec85 'https://raw.githubusercontent.com/rfxn/magento-malware-collection/master/malware/backend/de404053a7f33585cd1ff655f62dec85'
wget -qO "$d_MALDET_TESTS_WORKING"/8a86a21550fb7583887d8cecd484b497 'https://raw.githubusercontent.com/rfxn/magento-malware-collection/master/malware/backend/8a86a21550fb7583887d8cecd484b497'

### Change the ownership on said files
chown 500:500 "$d_MALDET_TESTS_WORKING"/*
touch "$d_MALDET_TESTS_WORKING"/ignore_paths

### Scan those files without clamscan
v_CONFIG=email_alert="0",scan_clamscan="0",quarantine_hits="0",quarantine_clean="0",quarantine_suspend_user="0",scan_tmpdir_paths="",ignore_paths="$d_MALDET_TESTS_WORKING/ignore_paths"
v_RESULTS="$( "$d_MALDET"/maldet --config-option "$v_CONFIG" -a "$d_MALDET_TESTS_WORKING" | grep "scan report saved" | awk '{print $NF}' )"

### 
if [[ $( grep -c "de404053a7f33585cd1ff655f62dec85\|8a86a21550fb7583887d8cecd484b497" "$d_MALDET"/sess/session.hits."$v_RESULTS" ) -ne 2 ]]; then
	echo "Scanning without Clamscan has failed" 2> /dev/stderr
	exit 1
fi
