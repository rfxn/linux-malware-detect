#! /bin/bash

echo -e "\e[34mTesting order of command line arguments\e[00m"

echo "Note: Instead of using the maldet executable, this test copies and makes modifications to it and other files. If this test fails, it might be a result of unexpected future changes to the following:"
echo "'$d_MALDET/maldet'"
echo "'$d_MALDET/internals/functions"

### Make a copy of the files we need to change
cp -a "$d_MALDET"/maldet "$d_MALDET_TESTS_WORKING"/maldet
cp -a "$d_MALDET"/internals/functions "$d_MALDET_TESTS_WORKING"/functions

### Modify maldet executable to print the word "background" and exit if background mode is invoked
sed -i '/-b|--background)/a echo "background";exit' "$d_MALDET_TESTS_WORKING"/maldet
### Modify maldet executable to point to the modified functions file
sed -i '/source $intfunc/i intfunc="'"$d_MALDET_TESTS_WORKING/functions\"" "$d_MALDET_TESTS_WORKING"/maldet
### Modify functions file so that the scan function prints the word "scan" and immediately exits
sed -i '/^scan[(][)] {/a echo "scan";exit' "$d_MALDET_TESTS_WORKING"/functions
### Modify functions file so that the sigup function prints the word "update" and immediately exits
sed -i '/^sigup[(][)] {/a echo "update";exit' "$d_MALDET_TESTS_WORKING"/functions
### Modify functions file so that the usage_long function prints the word "help" and immediately exits
sed -i '/^usage_long[(][)] {/a echo "help";exit' "$d_MALDET_TESTS_WORKING"/functions

### Run the modified scripts and see if they behave as expected
### Just "-a" launches a scan
v_TEST="$( "$d_MALDET_TESTS_WORKING"/maldet -a /home/user/public_html | tail -n1 )"
if [[ $v_TEST != "scan" ]]; then
	echo "Test 1 failed" > /dev/stderr
	exit 1
fi
### "-u" at any position, with or without "--force" starts and update before the scan
v_TEST="$( "$d_MALDET_TESTS_WORKING"/maldet -u -a /home/user/public_html | tail -n1 )"
if [[ $v_TEST != "update" ]]; then
	echo "Test 2 failed" > /dev/stderr
	exit 1
fi
v_TEST="$( "$d_MALDET_TESTS_WORKING"/maldet -a /home/user/public_html -u | tail -n1 )"
if [[ $v_TEST != "update" ]]; then
	echo "Test 3 failed" > /dev/stderr
	exit 1
fi
v_TEST="$( "$d_MALDET_TESTS_WORKING"/maldet -u --force -a /home/user/public_html | tail -n1 )"
if [[ $v_TEST != "update" ]]; then
	echo "Test 4 failed" > /dev/stderr
	exit 1
fi
v_TEST="$( "$d_MALDET_TESTS_WORKING"/maldet -a /home/user/public_html -u --force | tail -n1 )"
if [[ $v_TEST != "update" ]]; then
	echo "Test 5 failed" > /dev/stderr
	exit 1
fi
### "--help" at any position launches help before anything else
v_TEST="$( "$d_MALDET_TESTS_WORKING"/maldet -a --help /home/user/public_html -u --force | tail -n1 )"
if [[ $v_TEST != "help" ]]; then
	echo "Test 6 failed" > /dev/stderr
	exit 1
fi
v_TEST="$( "$d_MALDET_TESTS_WORKING"/maldet -a /home/user/public_html -u --force --help | tail -n1 )"
if [[ $v_TEST != "help" ]]; then
	echo "Test 7 failed" > /dev/stderr
	exit 1
fi
### "-b" updates whether we're in the background even if it comes after "-a"
v_TEST="$( "$d_MALDET_TESTS_WORKING"/maldet -a /home/user/public_html -u --force -b | tail -n1 )"
if [[ $v_TEST != "background" ]]; then
	echo "Test 8 failed" > /dev/stderr
	exit 1
fi
