#! /bin/bash

#====================================#
#== Initial Variables and Settings ==#
#====================================#

set -e

export PATH=$PATH:/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin

export d_MALDET="/usr/local/maldetect"
export d_MALDET_TESTS="$d_MALDET"/tests
export d_MALDET_TESTS_WORKING="$d_MALDET_TESTS"/working

b_SPECIFIC=false

#===============#
#== Functions ==#
#===============#

function fn_run_test {
	local f_TEST=
	### Make sure that we have everything in place necessary to run a test
	if [[ -n "$1" && -n $d_MALDET && -n "$d_MALDET_TESTS" && -n "$d_MALDET_TESTS_WORKING" ]]; then
		f_TEST="$1"
	else
		echo "Test file does not exist or required variables not set" > /dev/stderr
		fn_unskip
		exit 1
	fi

	### Destroy and create the working directory
	if [[ -d "$d_MALDET_TESTS_WORKING" ]]; then
		rm -rf "$d_MALDET_TESTS_WORKING"
	fi
	mkdir "$d_MALDET_TESTS_WORKING"

	### Make the test executable
	if [[ ! -x "$d_MALDET_TESTS"/"$f_TEST" ]]; then
		chmod +x "$d_MALDET_TESTS"/"$f_TEST"
	fi

	### Run the test script
	v_SUCCESS=true
	echo -e "\e[34mRunning tests from file '$f_TEST'\e[00m"
	"$d_MALDET_TESTS"/"$f_TEST" || v_SUCCESS=false

	### Make the test no longer executable
	chmod -x "$d_MALDET_TESTS"/"$f_TEST"

	### Exit if the test failed
	if [[ "$v_SUCCESS" == false ]]; then
		### If the script failed, exit
		echo -e "\e[31mFile '$f_TEST': Failed\e[00m" > /dev/stderr
		if [[ "$b_SPECIFIC" == false ]]; then
			echo "To skip these tests, add the flags '--skip $f_TEST'"
		fi
		fn_unskip 
		exit 1
	fi
	echo -e '\e[32mFile '$f_TEST': Success!\e[00m'
}

function fn_unskip {
	local v_NAME=
	for i in $( ls -1 "$d_MALDET_TESTS" | grep -E "^skipped_tests_[0-9_]+\.[^.]+$" ); do
		v_NAME="$( echo "$i" | sed "s/^skipped_//" )"
		mv -f "$d_MALDET_TESTS"/"$i" "$d_MALDET_TESTS"/"$v_NAME"
	done
}

#=====================#
#== Parse Arguments ==#
#=====================#

echo "Warning: It's possible that running these tests while there are ongoing scans or monitoring jobs might negatively impact both the ongoing processes and the results of this test."
read -ep "Are you sure that you want to continue? (Y/n) " v_CONTINUE
v_CONTINUE="${v_CONTINUE:0:1}"
if [[ "$v_CONTINUE" == "n" || "$v_CONTINUE" == "N" ]]; then
	exit 0
fi

fn_unskip
if [[ -n "$1" && "$1" != "--skip" ]]; then
### Run a single test script
	b_SPECIFIC=true
	while [[ -n "$1" ]]; do
		if [[ -f "$d_MALDET_TESTS"/"$1" ]]; then
			fn_run_test "$1"
		fi
		shift
	done
	exit 0
else
	### Skip any tests that were specified to be skipped
	if [[ "$1" == "--skip" ]]; then
		shift
		while [[ -n "$1" ]]; do
			if [[ -f "$d_MALDET_TESTS"/"$1" && $( echo "$1" | grep -Ec "^tests_[0-9_]+\.[^.]+$" ) -gt 0 ]]; then
				mv -f "$d_MALDET_TESTS"/"$1" "$d_MALDET_TESTS"/skipped_"$1"
			fi
			shift
		done
	fi

	### Iterate through all of the test scripts
	for i in $( ls -1 "$d_MALDET_TESTS" | sort -n | grep -E "^tests_[0-9_]+\.[^.]+$" ); do
		### Announce the set of tests that we're running
		fn_run_test "$i"
	done
	exit 0
fi
